<!DOCTYPE html>
<html>
  <head>
    <title>Joseph Chin - Drupal 8 - REST API Services</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="remark.css" type="text/css"/>
  </head>
  <body>
    <textarea id="source">

name: cover
class: center, bottom
background-image: url(images/slide-cover.jpg)
# Drupal 8 REST API Services
## Joseph Chin
---
# Hello
* Joseph Chin
* Drupal Solution Architect since 2007
* Singapore Drupal Meetup committee member
* jchin1968 on .media-icon[![image](images/google.png) ![image](images/twitter.png) ![image](images/linkedin.png) ![image](images/facebook.png) ![image](images/github-white.png)]
* Follow along here: https://rawgit.com/jchin1968/d8-rest-api-presentation/master/index.html


---
# Topics
* Setting up REST Services on Drupal 8
* GET, POST, PATCH and DELETE Requests
* Making Authenticated REST Calls
* Creating an endpoint using Views

???
* assumes you understand what is REST and why you'd want to use it.

---
# Setup - Modules 

| Required             | Useful  | Optional                   |
| :---                 | :---    | :---                       |
| Serialization        | REST UI | HAL                        |
| RESTFul Web Services |         | HTTP Basic Authentication  |
|                      |         | JSON API                   |
|                      |         | Graph QL                   |

???
* HAL - stands for Hypertext Application Language
* provides hyperlinks to related content? Not really sure of it's value

---
# Setup - REST Resources
* Go to "Configuration / Web Services / REST"
* Configure and Enable "Content"
* Configure and Enable "User"

???
# REST Resources
* Enable Content and User
* For each resource, enable all Request types: GET, POST, PATCH, DELETE, use JSON and cooke authentication 


---
# Setup - User Permissions
* REST APIs follow the same permission as normal pages

???
* Article node publicly accessible for viewing
* User node is accessible only by administrator

---
# Setup - CORS
### services.yml
```
cors.config:
    enabled: true 
    allowedHeaders: ['*']
    allowedMethods: ['GET', 'POST', 'PATCH']
    allowedOrigins: ['http://trusted-partner:8100']
    exposedHeaders: true 
    maxAge: 1000 
    supportsCredentials: true 
```
???
* CORS - cross origin resource sharing
* security feature to prevent a script from one domain to access resources (i.e. image, js, css, json) from another
* Drupal 8 is configured by default to prevent resource sharing 

---
# Basic GET Request
* Method: GET
* URL: http://rest-demo/node/1?_format=json

---
# Basic GET Response
```
{
  "nid": [{ "value" : 1 }], 
  ....,
  ....,
  "status": [{ "value" : true }],
  "title": [{ "value" : "The Quick Brown Fox" }],
  ....,
  ....,
  "body": [{
    "value" : "<p>The quick brown fox....the lazy dogs.</p>\r\n",
    "format" : "basic_html",
    "summary" : ""
  }],
  ....,
  ....
}

```

???
* Simplest request. Go to a browser and simply enter a URL
* In Drupal 8, you require the query parameter _format=json to identify it is json 

---

# Login POST Request
* Method: POST
* Header: Content-Type: application/json
* URL: http://rest-demo/user/login?_format=json
* Body: 
```
{ "name" : "joe", "pass" : "test" }
```

---
# Login POST Response
```
{
  "current_user" : { 
    "uid" : "2", 
    "name" : "joe", 
    "roles" : [ "authenticated", "editor", "member" ]
  },
* "csrf_token":"vVlThBvK_K0PNmkcSeNr1ntw8qxADc8v5h17Hugsiok",
  "logout_token":"zLskC3cKPp1rV00E7jxXihNk1Zk-uaAldsQiHa_VaSM"
}
```
<br>
* Retain CSRF Token for "unsafe" requests
* If server-side request (i.e. PHP code), retain the session cookie from the response header

???
* Slightly more complicated as it expects an HTTP body which you can't provide through the URL
* Use something like Postman to construct the body
* Sends out an OPTIONS (pre-flight) request first to see if you are allowed to connect and then the second request is the actual POST with your login credentials
* When on a browser (i.e. using Javascript), the browser handles the session cookie.
* When on a server, i.e. PHP cURL commands, you will need to construct a HTTP header with the session cookie. 
* The CSRF token is required for "Unsafe" requests ie. POST, PATCH, DELETE. Safe requests such as GET do not require the token
*

---
# Authenticated GET Request
* Method: GET
* URL: http://rest-demo/user/2?_format=json
* Session cookies are automatically handled with browser requests
* Session cookies need to be set in the HTTP header for server-side requests

---
name: auth-get-response
# Authenticated GET Response
#### HTTP 200 - Successful
```
{
  "uid" : [{ "value" : 2 }], 
  ....,
  ....,
  "name" : [{ "value" : "joe" }],
  "mail" : [{ "value" : "joe@test.com" }],
  "timezone" : [{ "value" : "Asia/Singapore" }],
  "status" : [{ "value" : true }],
  ....,
  ....
}

```
#### HTTP 403 - Failed
```
{"message":"The 'access user profiles' permission is required..."}
```

???
*

---
# Create Article Request
* Method: POST
* Header: 
  * Content-Type: application/json
  * X-CSRF-Token: vVlThBvK_K0P......v5h17Hugsiok
* URL: http://rest-demo/entity/node?_format=json
* Body:

```
      {
        "type" :[{ "target_id" : "article" }],
        "title" :[{ "value" : "Hello World" }],
        "body" : [{ "value" : "How are you?" }]
      }
```

---
# Create Article Response
```
{
  "nid": [{ "value" : 2 }], 
  ....,
  ....,
  "type": [{ "target_id" : "article", .... }],
  "status": [{ "value" : true }],
  "title": [{ "value" : "Hello World" }],
  ....,
  ....
}
```

???
*

---
# Update Article Request
* Method: PATCH
* Header: 
  * Content-Type: application/json
  * X-CSRF-Token: vVlThBvK_K0P......v5h17Hugsiok
* URL: http://rest-demo/node/2?_format=json
* Body:

```
    {
*     "type" : [{ "target_id" : "article" }],
      "title" : [{ "value" : "Hello Joe" }]
    }
```

---
# Update Article Response
```
{
  "nid" : [{ "value" : 2 }], 
  ....,
  ....,
  "title" : [{ "value" : "Hello Joe" }],
  ....,
  ....
}
```

???
*

---
# Delete Article Request
* Method: DELETE
* Header: 
  * X-CSRF-Token: vVlThBvK_K0P......v5h17Hugsiok
* URL: http://rest-demo/node/2?_format=json
* Omit Content-Type and Body

---
# Delete Article Response
* HTTP 204 - No Content

???
* HTTP 204 - Not an error message

---
# Create JSON List
* No lists provided by default
* Create using Views

???
* Accessing a single entity via REST is provided out of the box but to get a list requires creating views

---
name: references
# References
* https://www.drupal.org/docs/8/core/modules/rest/javascript-and-drupal-8-restful-web-services   

---
# Q&amp;A

.center.middle[![image](images/questionmarktie.jpg)]




    </textarea>
    <script src="remark.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create({
        highlightLines: true
      });
    </script>
  </body>
</html>
